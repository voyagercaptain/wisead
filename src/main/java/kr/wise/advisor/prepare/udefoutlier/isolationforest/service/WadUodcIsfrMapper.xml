<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfrMapper">
	<resultMap id="BaseResultMap" type="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr" extends="kr.wise.commons.cmm.service.CommonMapper.BaseResultMap" >
		<id column="UDF_OTL_DTC_ID"      jdbcType="VARCHAR"   property="udfOtlDtcId" />
		<id column="CRE_COMP_ID"         jdbcType="VARCHAR"   property="creCompId" />
		<result column="ANA_DASE_ID"     jdbcType="VARCHAR"   property="anaDaseId" />
		<result column="ANA_DASE_NM"     jdbcType="VARCHAR"   property="anaDaseNm" />
		<result column="SRC_ANA_DASE_ID" jdbcType="VARCHAR"   property="srcAnaDaseId" />
		<result column="OTL_COL_PNM"     jdbcType="VARCHAR"   property="otlColPnm" />
		<result column="OTL_RT"  		 jdbcType="REAL"   	  property="otlRt" />
		
		<result column="COL_PNM"		 jdbcType="VARCHAR"	  property="colPnm"       />
		<result column="COL_LNM"		 jdbcType="VARCHAR"	  property="colLnm"       />
		<result column="SRC_ANA_DASE_NM" jdbcType="VARCHAR"   property="srcAnaDaseNm" />
		
		<result column="DATA_TYPE"       jdbcType="VARCHAR"   property="dataType"  />
	</resultMap>
	
	<select id="selectDetailInfo" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr" resultMap="BaseResultMap">
		SELECT A.UDF_OTL_DTC_ID
	         , A.CRE_COMP_ID
	         , A.ANA_DASE_ID
	         , A.SRC_ANA_DASE_ID
	         , A.OTL_COL_PNM
	         , A.OTL_RT
	         , B.ANA_DASE_NM 
	     FROM WAD_UODC_ISL_FRST A
	          LEFT JOIN WAD_UODC_ANA_DASE B
	            ON B.ANA_DASE_ID = A.ANA_DASE_ID
	     WHERE A.UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	     	AND A.CRE_COMP_ID   = #{creCompId,jdbcType=VARCHAR}
	</select>
	
	<select id="selectIsfrColList" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr" resultMap="BaseResultMap">
	   SELECT A.COL_PNM
	        , A.COL_LNM
	        , D.DATA_TYPE
            , CASE WHEN (C.COL_PNM) IS NOT NULL THEN 1 ELSE 0 END AS IBS_CHECK 
		 FROM WAD_UODC_ANA_DASE_COL A
              LEFT JOIN WAD_UODC_ISL_FRST B
                ON A.ANA_DASE_ID = B.SRC_ANA_DASE_ID
              LEFT JOIN WAD_UODC_ANA_DASE_COL C
                ON B.ANA_DASE_ID = C.ANA_DASE_ID
               AND A.COL_PNM     = C.COL_PNM
              LEFT JOIN WAD_ANA_VAR D
		       ON D.ANL_VAR_ID = A.ANA_VAR_ID
		WHERE A.ANA_DASE_ID = #{srcAnaDaseId,jdbcType=VARCHAR}
		ORDER BY A.ANA_COL_SNO
	</select>
	
	<update id="updateIsfr" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr">
		UPDATE WAD_UODC_ISL_FRST
		<set>
			<if test="anaDaseId != null">
				ANA_DASE_ID = #{anaDaseId,jdbcType=VARCHAR},
			</if>
			<if test="srcAnaDaseId != null">
				SRC_ANA_DASE_ID = #{srcAnaDaseId,jdbcType=VARCHAR},
			</if>
			<if test="otlColPnm != null">
				OTL_COL_PNM = #{otlColPnm, jdbcType=VARCHAR},
			</if>
			<if test="otlRt != null">
				OTL_RT = #{otlRt, jdbcType=VARCHAR},
			</if>
			<if test="objDescn != null">
				OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
			</if>
			<if test="objVers != null">
				OBJ_VERS = #{objVers,jdbcType=VARCHAR},
			</if>
			<if test="regTypCd != null">
				REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
			</if>
			<if test="writUserId != null">
				WRIT_USER_ID = #{writUserId,jdbcType=VARCHAR},
			</if>
			<if test="writDtm != null">
				WRIT_DTM = #{writDtm,jdbcType=TIMESTAMP},
			</if>
		</set>
		WHERE UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	      AND CRE_COMP_ID    = #{creCompId,jdbcType=VARCHAR}
	</update>
	
	<insert id="insertIsfr" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr">
		INSERT INTO WAD_UODC_ISL_FRST
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="udfOtlDtcId != null">
				UDF_OTL_DTC_ID,
			</if>
			<if test="creCompId != null">
				CRE_COMP_ID,
			</if>
			<if test="anaDaseId != null">
				ANA_DASE_ID,
			</if>
			<if test="srcAnaDaseId != null">
				SRC_ANA_DASE_ID,
			</if>
			<if test="otlColPnm != null">
				OTL_COL_PNM,
			</if>
			<if test="otlRt != null">
				OTL_RT,
			</if>
			<if test="objDescn != null">
				OBJ_DESCN,
			</if>	      
		        OBJ_VERS,      
		        REG_TYP_CD,      
		        WRIT_USER_ID,      
		        WRIT_DTM 
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="udfOtlDtcId != null">
				#{udfOtlDtcId,jdbcType=VARCHAR},
			</if>
			<if test="creCompId != null">
				#{creCompId,jdbcType=VARCHAR},
			</if>
			<if test="anaDaseId != null">
				#{anaDaseId,jdbcType=VARCHAR},
			</if>
			<if test="srcAnaDaseId != null">
				#{srcAnaDaseId,jdbcType=VARCHAR},
			</if>
			<if test="otlColPnm != null">
				#{otlColPnm, jdbcType=VARCHAR},
			</if>
			<if test="otlRt != null">
				#{otlRt, jdbcType=VARCHAR},
			</if>
			<if test="objDescn != null">
				#{objDescn,jdbcType=VARCHAR},
			</if>
	        1,
	       'C',      
	        #{writUserId,jdbcType=VARCHAR},      
	        now() 
	    </trim>
	</insert>
	
	<update id="updateIsfrAnaDaseId" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr">
		<![CDATA[
	  	 UPDATE WAD_UODC_ISL_FRST A
	  	     SET ANA_DASE_ID = (SELECT ANA_DASE_ID
			                      FROM WAD_UODC_ANA_DASE X 
			                     WHERE X.UDF_OTL_DTC_ID = A.UDF_OTL_DTC_ID
			                       AND X.CRE_COMP_ID    = A.CRE_COMP_ID 
			                       AND ROWNUM <= 1
			                   )   
	  	  WHERE UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	        AND CRE_COMP_ID    = #{creCompId,jdbcType=VARCHAR}
	    ]]>
	</update>
	
	<update id="updateIsfrAnaDaseColId" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr">
		<![CDATA[
	  	 UPDATE WAD_UODC_ANA_DASE_COL A
	  	     SET ANA_DASE_ID = (SELECT ANA_DASE_ID
			                      FROM WAD_UODC_ISL_FRST X 
			                     WHERE X.UDF_OTL_DTC_ID = A.UDF_OTL_DTC_ID
			                       AND X.CRE_COMP_ID    = A.CRE_COMP_ID 
			                       AND ROWNUM <= 1
			                   )   
	  	  WHERE UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	        AND CRE_COMP_ID    = #{creCompId,jdbcType=VARCHAR}
	    ]]>
	</update>
	
	<delete id="deleteByPrimaryKey" parameterType="map">
	    delete from WAD_UODC_ISL_FRST
	    where UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	      and CRE_COMP_ID = #{creCompId,jdbcType=VARCHAR}
	</delete>
	
	<delete id="deleteByUdfOtlDtcId" parameterType="map">
	    delete from WAD_UODC_ISL_FRST
	    where UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	</delete>
	
	<select id="selectUodcIsfrColLstForScrt" parameterType="kr.wise.advisor.prepare.udefoutlier.isolationforest.service.WadUodcIsfr" resultMap="BaseResultMap">
	   
		SELECT A.UDF_OTL_DTC_ID
		     , A.CRE_COMP_ID
		     , A.OTL_COL_PNM
		     , A.OTL_RT
		     , C.COL_PNM       
		     , A.ANA_DASE_ID
		     , B.ANA_DASE_NM
		     , A.SRC_ANA_DASE_ID
		     , D.ANA_DASE_NM     AS SRC_ANA_DASE_NM
		  FROM WAD_UODC_ISL_FRST A
		       LEFT JOIN WAD_UODC_ANA_DASE B
		         ON B.ANA_DASE_ID = A.ANA_DASE_ID
		       LEFT JOIN WAD_UODC_ANA_DASE_COL C
		         ON C.ANA_DASE_ID = B.ANA_DASE_ID
		       LEFT JOIN WAD_UODC_ANA_DASE D
		         ON D.ANA_DASE_ID = A.SRC_ANA_DASE_ID  
		 WHERE 1 = 1         
		   AND A.UDF_OTL_DTC_ID = #{udfOtlDtcId,jdbcType=VARCHAR}
	       AND A.CRE_COMP_ID    = #{creCompId,jdbcType=VARCHAR}
		 ORDER BY C.ANA_COL_SNO
	</select>
</mapper>